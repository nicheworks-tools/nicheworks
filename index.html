<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NicheWorks</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="site-title">
        <img class="site-logo" src="/assets/nicheworks-logo.png" alt="NicheWorks" onerror="this.remove()">
        <h1>NicheWorks</h1>
      </div>

      <p class="subtitle">ブラウザだけで使える軽量ツール集。入力データは保存しません（原則ローカル処理）。</p>

      <nav class="nav-inline" aria-label="Site navigation">
        <a href="./index.html">Home</a>
        <span class="sep">/</span>
        <a href="./about.html">About</a>
        <span class="sep">/</span>
        <a href="./privacy.html">Privacy</a>
        <span class="sep">/</span>
        <a href="./contact.html">Contact</a>
        <span class="sep">/</span>
        <a href="./en/index.html">EN</a>
      </nav>
    </header>

    <main>
      <section class="block">
        <h2>NicheWorks とは</h2>
        <p class="category-desc">
          “静かに便利に”。その場で使って終わる、保存なし・匿名利用前提の小さなツール群です。
        </p>
      </section>

      <section class="block">
        <h2>ツール</h2>
        <p class="category-desc">
          検索してすぐ開けるように、カテゴリで短くまとめています。全件は下の「全ツール一覧（長い）」を開いてください。
        </p>

        <div class="tool-search">
          <input id="nw-tool-q" class="input" type="search" placeholder="ツール名/キーワードで検索（例: pdf / 画像 / 契約 / 建設）" autocomplete="off">
          <div class="tool-search-meta">
            <div class="small muted">合計：<span id="nw-tool-count">...</span></div>
          </div>
        </div>

        <!-- よく使う（短く） -->
        <div class="tool-pins" id="nw-tool-pins" aria-label="よく使う">
          <span class="small muted">読み込み中...</span>
        </div>

        <!-- カテゴリカード（短く） -->
        <div id="nw-tool-cats" class="tool-cat-grid">
          <div class="small muted">読み込み中...</div>
        </div>

        <!-- 全件（長い）= 折りたたみ＋開いた時だけ描画 -->
        <details class="tool-all" id="nw-tool-all-wrap">
          <summary>全ツール一覧（長い）を開く</summary>
          <div id="nw-tool-all" class="tool-grid">
            <div class="small muted">（未表示）</div>
          </div>
        </details>

        <script>
        (async function () {
          const $ = (id) => document.getElementById(id);

          const qEl = $("nw-tool-q");
          const pinsEl = $("nw-tool-pins");
          const catsEl = $("nw-tool-cats");
          const countEl = $("nw-tool-count");
          const allWrapEl = $("nw-tool-all-wrap");
          const allEl = $("nw-tool-all");

          const escapeHtml = (s) => String(s || "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");

          const normalize = (it) => {
            const name = (it.title_ja && it.title_ja !== it.slug) ? it.title_ja : it.slug;
            const desc = (it.desc_ja || "").trim();
            return { ...it, name, desc };
          };

          // 上に出す（短く）
          const PINNED = [
            "construction-tools-atlas",
            "pdf2csv-local",
            "api-key-token-redactor",
            "command-safety-checker",
            "contract-cleaner",
            "exif-cleaner-mini",
            "filetype-sniffer",
            "image-compression-inspector",
            "color-replace",
            "json2mermaid",
            "jp-postal-lite",
            "wifi-meter",
            "weatherdiff"
          ];

          // カテゴリは “短く” まとめる（定義順で表示）
          const CATS = [
            { key: "PDF/書類", hint: "PDF/CSV/明細など", match: (s) => /pdf|csv|xlsx|invoice|receipt|statement/.test(s) },
            { key: "画像/ファイル", hint: "画像/EXIF/変換/圧縮など", match: (s) => /image|exif|webp|avif|color|compress|resize|png|jpg|filetype|sniffer/.test(s) },
            { key: "文章/作業", hint: "文章整形/テンプレ/契約など", match: (s) => /contract|cover-letter|linebreak|message|rename|log|text|paste|doc/.test(s) },
            { key: "開発/安全", hint: "JSON/コマンド/キー/プライバシー", match: (s) => /json|mermaid|token|api|key|format|privacy|risk|sql/.test(s) },
            { key: "生活", hint: "郵便/天気/Wi-Fi/家事など", match: (s) => /postal|wifi|weather|laundry|trash|manual/.test(s) },
            { key: "建設", hint: "建設/現場の辞典", match: (s) => /construction/.test(s) },
            { key: "その他", hint: "その他", match: (_) => true }
          ];

          const toolLink = (it) => {
            const name = escapeHtml(it.name);
            const desc = escapeHtml(it.desc);
            const href = `/tools/${it.slug}/`;
            return `<li>
              <strong><a href="${href}" target="_blank" rel="noopener">${name}</a></strong>
              ${desc ? `<div class="small muted">${desc}</div>` : ``}
            </li>`;
          };

          const pill = (it) => {
            const name = escapeHtml(it.name);
            const href = `/tools/${it.slug}/`;
            return `<a class="pill" href="${href}" target="_blank" rel="noopener">${name}</a>`;
          };

          const card = (catKey, hint, list) => {
            const LIMIT = 6;
            const shown = list.slice(0, LIMIT);
            const hidden = list.slice(LIMIT);
            const id = "cat_" + catKey.replaceAll(/[^a-zA-Z0-9]+/g, "_");

            return `<section class="tool-cat-card" data-cat="${escapeHtml(catKey)}">
              <div class="tool-cat-top">
                <div class="tool-cat-head">
                  <div class="tool-cat-title">${escapeHtml(catKey)} <span class="tool-cat-count">(${list.length})</span></div>
                  <div class="tool-cat-hint">${escapeHtml(hint)}</div>
                </div>
                ${hidden.length ? `<button class="tool-more" type="button" data-target="${escapeHtml(id)}">もっと見る</button>` : ``}
              </div>

              <ul class="list compact">
                ${shown.map(toolLink).join("")}
              </ul>

              ${hidden.length ? `
                <div id="${escapeHtml(id)}" class="tool-hidden" hidden>
                  <ul class="list compact">
                    ${hidden.map(toolLink).join("")}
                  </ul>
                </div>` : ``}
            </section>`;
          };

          const byCategory = (items) => {
            const buckets = new Map();
            for (const it of items) {
              const s = `${it.slug} ${it.name} ${it.desc} ${(it.tags || []).join(" ")}`.toLowerCase();
              const cat = (CATS.find(c => c.match(s)) || CATS[CATS.length - 1]).key;
              if (!buckets.has(cat)) buckets.set(cat, []);
              buckets.get(cat).push(it);
            }
            const ordered = [];
            for (const c of CATS) {
              if (buckets.has(c.key)) ordered.push([c.key, c.hint, buckets.get(c.key)]);
            }
            return ordered;
          };

          const renderPinned = (items) => {
            const map = new Map(items.map(it => [it.slug, it]));
            const pinned = PINNED.map(slug => map.get(slug)).filter(Boolean);
            pinsEl.innerHTML = pinned.length
              ? pinned.map(pill).join("")
              : `<span class="small muted">（ピン留めなし）</span>`;
          };

          const filterItems = (items, q) => {
            const query = (q || "").trim().toLowerCase();
            if (!query) return items;
            return items.filter(it => {
              const hay = `${it.slug} ${it.name} ${it.desc} ${(it.tags||[]).join(" ")}`.toLowerCase();
              return hay.includes(query);
            });
          };

          const renderCats = (items, q) => {
            const filtered = filterItems(items, q);
            const groups = byCategory(filtered);

            catsEl.innerHTML = groups
              .filter(([_, __, list]) => list.length)
              .map(([catKey, hint, list]) => card(catKey, hint, list))
              .join("") || `<div class="small muted">該当なし</div>`;

            // “もっと見る”
            catsEl.querySelectorAll(".tool-more").forEach(btn => {
              btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-target");
                const box = document.getElementById(id);
                if (box) box.hidden = false;
                btn.remove();
              }, { once: true });
            });
          };

          const renderAll = (items, q) => {
            const filtered = filterItems(items, q);
            allEl.innerHTML = filtered.map(it => {
              const name = escapeHtml(it.name);
              const desc = escapeHtml(it.desc);
              const href = `/tools/${it.slug}/`;
              return `<a class="tool-card" href="${href}" target="_blank" rel="noopener">
                <div class="tool-card-title">${name}</div>
                ${desc ? `<div class="tool-card-desc">${desc}</div>` : `<div class="tool-card-desc muted">（説明なし）</div>`}
                <div class="tool-card-meta">${escapeHtml(it.slug)}</div>
              </a>`;
            }).join("") || `<div class="small muted">該当なし</div>`;
          };

          let data;
          try {
            const res = await fetch("/tools/tools-index.json", { cache: "no-store" });
            data = await res.json();
          } catch (e) {
            pinsEl.innerHTML = `<span class="small muted">読み込み失敗</span>`;
            catsEl.innerHTML = `<div class="small muted">読み込み失敗</div>`;
            allEl.innerHTML = `<div class="small muted">読み込み失敗</div>`;
            return;
          }

          const items = (data.items || []).map(normalize);
          countEl.textContent = String(data.total || items.length);

          renderPinned(items);
          renderCats(items, "");

          // 全件は「開いた時だけ」描画
          allEl.innerHTML = `<div class="small muted">（未表示）</div>`;
          allWrapEl.addEventListener("toggle", () => {
            if (allWrapEl.open && allEl.dataset.rendered !== "1") {
              renderAll(items, qEl.value);
              allEl.dataset.rendered = "1";
            }
          });

          qEl.addEventListener("input", () => {
            renderCats(items, qEl.value);
            if (allWrapEl.open) renderAll(items, qEl.value);
          });
        })();
        </script>
      </section>

      <section class="block donate-block">
        <h2>運営サポート</h2>
        <p class="category-desc">もし役に立ったら、サポート（寄付）で応援できます。</p>
        <div class="donate-buttons">
          <a href="#" rel="noopener">☕ OFUSE</a>
          <a href="#" rel="noopener">❤️ Ko-fi</a>
        </div>
      </section>

      <footer>
        <div class="small">
          <p class="small">
            <a href="./index.html">Home</a> /
            <a href="./about.html">About</a> /
            <a href="./privacy.html">Privacy</a> /
            <a href="./contact.html">Contact</a>
          </p>
          <p class="small">運営：NicheWorks</p>
          <p class="small muted">一部のツールでは運営のため広告が表示される場合があります。</p>
        </div>
      </footer>
    </main>
  </div>
</body>
</html>
