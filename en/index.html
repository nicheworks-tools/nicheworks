<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NicheWorks</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="site-title">
        <img class="site-logo" src="/assets/nicheworks-logo.png" alt="NicheWorks" onerror="this.remove()">
        <h1>NicheWorks</h1>
      </div>

      <p class="subtitle">Lightweight tools that run in your browser. No input data is stored (local-first).</p>

      <nav class="nav-inline" aria-label="Site navigation">
        <a href="/en/">Home</a>
        <span class="sep">/</span>
        <a href="/en/about.html">About</a>
        <span class="sep">/</span>
        <a href="/en/privacy.html">Privacy</a>
        <span class="sep">/</span>
        <a href="/en/contact.html">Contact</a>
        <span class="sep">/</span>
        <a href="/en/index.html">EN</a>
      </nav>
    </header>

    <main>
      <section class="block">
        <h2>About NicheWorks</h2>
        <p class="category-desc">
          Quietly useful. Small tools you can use and leave—no accounts, no storage, no tracking by default.
        </p>
      </section>

      <section class="block">
        <h2>Tools</h2>
        <p class="category-desc">
          Categories are kept short so you can open tools quickly. For the full list, open “All tools (long list)” below.
        </p>

        <div class="tool-search">
          <input id="nw-tool-q" class="input" type="search" placeholder="Search tools / keywords (e.g. pdf / image / contract / construction)" autocomplete="off">
          <div class="tool-search-meta">
            <div class="small muted">Total: <span id="nw-tool-count">...</span></div>
          </div>
        </div>

        <!-- Pinned (short) -->
        <div class="tool-pins" id="nw-tool-pins" aria-label="Pinned tools">
          <span class="small muted">Loading...</span>
        </div>

        <!-- Category cards (short) -->
        <div id="nw-tool-cats" class="tool-cat-grid">
          <div class="small muted">Loading...</div>
        </div>

        <!-- All (long) -->
        <details class="tool-all" id="nw-tool-all-wrap">
          <summary>Open all tools (long list)</summary>
          <div id="nw-tool-all" class="tool-grid">
            <div class="small muted">(not rendered)</div>
          </div>
        </details>

        <script>
        (async function () {
          const $ = (id) => document.getElementById(id);

          const qEl = $("nw-tool-q");
          const pinsEl = $("nw-tool-pins");
          const catsEl = $("nw-tool-cats");
          const countEl = $("nw-tool-count");
          const allWrapEl = $("nw-tool-all-wrap");
          const allEl = $("nw-tool-all");

          const escapeHtml = (s) => String(s || "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");

          const normalize = (it) => {
            const name = (it.title_en && it.title_en !== it.slug) ? it.title_en : it.slug;
            const desc = (it.desc_en || "").trim();
            return { ...it, name, desc };
          };

          const PINNED = [
            "construction-tools-atlas",
            "pdf2csv-local",
            "api-key-token-redactor",
            "command-safety-checker",
            "contract-cleaner",
            "exif-cleaner-mini",
            "filetype-sniffer",
            "image-compression-inspector",
            "color-replace",
            "json2mermaid",
            "jp-postal-lite",
            "wifi-meter",
            "weatherdiff"
          ];

          const CATS = [
            { key: "PDF / Docs", hint: "PDF/CSV/statements", match: (s) => /pdf|csv|xlsx|invoice|receipt|statement/.test(s) },
            { key: "Images / Files", hint: "EXIF/convert/compress", match: (s) => /image|exif|webp|avif|color|compress|resize|png|jpg|filetype|sniffer/.test(s) },
            { key: "Writing / Work", hint: "text/format/templates", match: (s) => /contract|cover-letter|linebreak|message|rename|log|text|paste|doc/.test(s) },
            { key: "Dev / Safety", hint: "JSON/commands/keys", match: (s) => /json|mermaid|token|api|key|format|privacy|risk|sql/.test(s) },
            { key: "Daily", hint: "postal/weather/Wi-Fi", match: (s) => /postal|wifi|weather|laundry|trash|manual/.test(s) },
            { key: "Construction", hint: "construction glossary", match: (s) => /construction/.test(s) },
            { key: "Other", hint: "misc", match: (_) => true }
          ];

          const toolLink = (it) => {
            const name = escapeHtml(it.name);
            const desc = escapeHtml(it.desc);
            const href = `/tools/${it.slug}/`;
            return `<li>
              <strong><a href="${href}" target="_blank" rel="noopener">${name}</a></strong>
              ${desc ? `<div class="small muted">${desc}</div>` : ``}
            </li>`;
          };

          const pill = (it) => {
            const name = escapeHtml(it.name);
            const href = `/tools/${it.slug}/`;
            return `<a class="pill" href="${href}" target="_blank" rel="noopener">${name}</a>`;
          };

          const card = (catKey, hint, list) => {
            const LIMIT = 6;
            const shown = list.slice(0, LIMIT);
            const hidden = list.slice(LIMIT);
            const id = "cat_" + catKey.replaceAll(/[^a-zA-Z0-9]+/g, "_");

            return `<section class="tool-cat-card" data-cat="${escapeHtml(catKey)}">
              <div class="tool-cat-top">
                <div class="tool-cat-head">
                  <div class="tool-cat-title">${escapeHtml(catKey)} <span class="tool-cat-count">(${list.length})</span></div>
                  <div class="tool-cat-hint">${escapeHtml(hint)}</div>
                </div>
                ${hidden.length ? `<button class="tool-more" type="button" data-target="${escapeHtml(id)}">More</button>` : ``}
              </div>

              <ul class="list compact">
                ${shown.map(toolLink).join("")}
              </ul>

              ${hidden.length ? `
                <div id="${escapeHtml(id)}" class="tool-hidden" hidden>
                  <ul class="list compact">
                    ${hidden.map(toolLink).join("")}
                  </ul>
                </div>` : ``}
            </section>`;
          };

          const byCategory = (items) => {
            const buckets = new Map();
            for (const it of items) {
              const s = `${it.slug} ${it.name} ${it.desc} ${(it.tags || []).join(" ")}`.toLowerCase();
              const cat = (CATS.find(c => c.match(s)) || CATS[CATS.length - 1]).key;
              if (!buckets.has(cat)) buckets.set(cat, []);
              buckets.get(cat).push(it);
            }
            const ordered = [];
            for (const c of CATS) {
              if (buckets.has(c.key)) ordered.push([c.key, c.hint, buckets.get(c.key)]);
            }
            return ordered;
          };

          const renderPinned = (items) => {
            const map = new Map(items.map(it => [it.slug, it]));
            const pinned = PINNED.map(slug => map.get(slug)).filter(Boolean);
            pinsEl.innerHTML = pinned.length
              ? pinned.map(pill).join("")
              : `<span class="small muted">(no pinned tools)</span>`;
          };

          const filterItems = (items, q) => {
            const query = (q || "").trim().toLowerCase();
            if (!query) return items;
            return items.filter(it => {
              const hay = `${it.slug} ${it.name} ${it.desc} ${(it.tags||[]).join(" ")}`.toLowerCase();
              return hay.includes(query);
            });
          };

          const renderCats = (items, q) => {
            const filtered = filterItems(items, q);
            const groups = byCategory(filtered);

            catsEl.innerHTML = groups
              .filter(([_, __, list]) => list.length)
              .map(([catKey, hint, list]) => card(catKey, hint, list))
              .join("") || `<div class="small muted">No matches</div>`;

            catsEl.querySelectorAll(".tool-more").forEach(btn => {
              btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-target");
                const box = document.getElementById(id);
                if (box) box.hidden = false;
                btn.remove();
              }, { once: true });
            });
          };

          const renderAll = (items, q) => {
            const filtered = filterItems(items, q);
            allEl.innerHTML = filtered.map(it => {
              const name = escapeHtml(it.name);
              const desc = escapeHtml(it.desc);
              const href = `/tools/${it.slug}/`;
              return `<a class="tool-card" href="${href}" target="_blank" rel="noopener">
                <div class="tool-card-title">${name}</div>
                ${desc ? `<div class="tool-card-desc">${desc}</div>` : `<div class="tool-card-desc muted">(no description)</div>`}
                <div class="tool-card-meta">${escapeHtml(it.slug)}</div>
              </a>`;
            }).join("") || `<div class="small muted">No matches</div>`;
          };

          let data;
          try {
            const res = await fetch("/tools/tools-index.json", { cache: "no-store" });
            data = await res.json();
          } catch (e) {
            pinsEl.innerHTML = `<span class="small muted">Failed to load</span>`;
            catsEl.innerHTML = `<div class="small muted">Failed to load</div>`;
            allEl.innerHTML = `<div class="small muted">Failed to load</div>`;
            return;
          }

          const items = (data.items || []).map(normalize);
          countEl.textContent = String(data.total || items.length);

          renderPinned(items);
          renderCats(items, "");

          allEl.innerHTML = `<div class="small muted">(not rendered)</div>`;
          allWrapEl.addEventListener("toggle", () => {
            if (allWrapEl.open && allEl.dataset.rendered !== "1") {
              renderAll(items, qEl.value);
              allEl.dataset.rendered = "1";
            }
          });

          qEl.addEventListener("input", () => {
            renderCats(items, qEl.value);
            if (allWrapEl.open) renderAll(items, qEl.value);
          });
        })();
        </script>
      </section>

      <section class="block donate-block">
        <h2>Support</h2>
        <p class="category-desc">If this helped you, you can support the project with a small donation.</p>
        <div class="donate-buttons">
          <a href="#" rel="noopener">☕ OFUSE</a>
          <a href="#" rel="noopener">❤️ Ko-fi</a>
        </div>
      </section>

      <footer>
        <div class="small">
          <p class="small">
            <a href="/en/">Home</a> /
            <a href="/en/about.html">About</a> /
            <a href="/en/privacy.html">Privacy</a> /
            <a href="/en/contact.html">Contact</a>
          </p>
          <p class="small">Owner: NicheWorks</p>
          <p class="small muted">Some tools may show ads to support operations.</p>
        </div>
      </footer>
    </main>
  </div>
</body>
</html>
